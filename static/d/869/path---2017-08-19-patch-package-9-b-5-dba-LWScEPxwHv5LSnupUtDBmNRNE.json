{"data":{"site":{"siteMetadata":{"title":"Christian Brevik","author":"Christian Brevik"}},"markdownRemark":{"id":"41286e5a-b15c-5719-a3b6-de3a230404ac","excerpt":"Anyone who has worked with React Native (RN) for some time know that the core contributors are not afraid of introducing breaking changes…","html":"<p>Anyone who has worked with React Native (RN) for some time know that the core contributors are not afraid of introducing breaking changes. So upgrading from one version to the next can sometimes be difficult.</p>\n<p>It became a lot easier when they introduced <a href=\"https://www.npmjs.com/package/react-native-git-upgrade\"><code class=\"language-text\">react-native-git-upgrade</code></a>, which if you aren’t using yet, then you are seriously missing out.</p>\n<p>But that just helps you upgrade your project code, what about your dependencies? For example in RN <a href=\"https://github.com/facebook/react-native/releases/tag/v0.47.0\"><code class=\"language-text\">0.47.0</code></a> they removed <code class=\"language-text\">createJSModules</code> which countless modules (<a href=\"https://github.com/idehub/react-native-google-analytics-bridge/blob/127886b27d80f1a20ee788ead6f6b79e43eef6f1/android/src/main/java/com/idehub/GoogleAnalyticsBridge/GoogleAnalyticsBridgePackage.java#L36-L39\">even one of mine</a>) have been overriding in their Android <code class=\"language-text\">ReactPackage</code>.</p>\n<p>Because it no longer existed, the <code class=\"language-text\">@Override</code> annotation on the <code class=\"language-text\">createJSModules</code> method meant the module wouldn’t compile at all. This effectively broke the dependencies of people who decided to upgrade to RN <code class=\"language-text\">0.47.0</code>.</p>\n<p>Fixing it is almost too easy. Just <a href=\"https://github.com/idehub/react-native-google-analytics-bridge/blob/915ae33b5a107d27d5562666a3c1cb04f3f0c805/android/src/main/java/com/idehub/GoogleAnalyticsBridge/GoogleAnalyticsBridgePackage.java#L36\">remove the annotation</a>, and the module will compile again. But not every dependency I was using for my app had fixed it yet. And that’s totally fine, working with open source is something people do voluntary, and a lot of the time life gets in the way<sup id=\"fnref-1\"><a href=\"#fn-1\" class=\"footnote-ref\">1</a></sup>.</p>\n<p>At this point we could roll back to the previous version of RN, and philosophize on the dangers of staying on the bleeding edge. But sometimes you just need to upgrade. In my case I needed a <a href=\"https://github.com/facebook/react-native/commit/64825389dfb4e01d5b30cd63b0b41937a9bb431d\">bugfix</a> which affected debugging an app.</p>\n<p>So, the non-compiling module hasn’t been updated yet, but you know how to fix it. One possibility is forking the dependency on Github, add the fix, and point your <code class=\"language-text\">package.json</code> to that fork.</p>\n<p>But that’s a bit like using a sledgehammer to crack a nut. Either way, it will probably be fixed soon upstream.</p>\n<h3>Use patch-package instead</h3>\n<p>I suggest instead that you use <a href=\"https://github.com/ds300/patch-package\">patch-package</a> which will let you patch your dependencies. This is another nice utility from <a href=\"https://github.com/ds300/\">David Sheldrick</a>, who also made the TypeScript-transformer in my <a href=\"/easy-typescript-with-react-native\">other blog post</a>.</p>\n<p>This utility will generate a <code class=\"language-text\">.patch</code> file, which you can commit to your repository. And then <code class=\"language-text\">patch-package</code> will re-apply the fix everytime someone installs the dependencies, which works with both <code class=\"language-text\">npm</code> and <code class=\"language-text\">yarn</code>.</p>\n<p>It is quite simple to set up, you install it in your project with:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">yarn add --dev patch-package</code></pre></div>\n<p>Then add the following script in your <code class=\"language-text\">package.json</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token property\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"prepare\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"patch-package\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Next you can fix the dependency as it is in your <code class=\"language-text\">node_modules</code> directory, and then create a <code class=\"language-text\">.patch</code> file.</p>\n<h3>An example</h3>\n<p>Let’s say we’re using <code class=\"language-text\">react-native-google-analytics-bridge@5.1.0</code> in our app, which was a pre-<code class=\"language-text\">0.47</code> version. The offending file in this case is <code class=\"language-text\">GoogleAnalyticsBridgePackage.java</code>, on <a href=\"https://github.com/idehub/react-native-google-analytics-bridge/blob/127886b27d80f1a20ee788ead6f6b79e43eef6f1/android/src/main/java/com/idehub/GoogleAnalyticsBridge/GoogleAnalyticsBridgePackage.java#L36\">line 36</a>. That <code class=\"language-text\">@Override</code> annotation is preventing the module from compiling.</p>\n<p>We can open that file in an editor, e.g. <code class=\"language-text\">vim node_modules/react-native-google-analytics-bridge/android/src/main/java/com/idehub/GoogleAnalyticsBridge/GoogleAnalyticsBridgePackage.java</code>, to fix the bug in the installed dependency. In this case I just remove <code class=\"language-text\">@Override</code>, and add <code class=\"language-text\">// Removed in RN 0.47.0</code> instead.</p>\n<p>I then save the file, and run <code class=\"language-text\">yarn run patch-package -- react-native-google-analytics-bridge</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">☑ Creating temporary folder\n☑ Building clean node_modules with yarn\n☑ Diffing your files with clean files\n✔ Created file patches/react-native-google-analytics-bridge+5.1.0.patch</code></pre></div>\n<p>As you see, it compares a clean install to your modified dependency, and creates a <code class=\"language-text\">patches</code> directory, with a <code class=\"language-text\">.patch</code> file. The name of the patch contains the dependency-name and the version number.</p>\n<p>The patch file itself is very readable if you open it in the correct software. I like using Beyond Compare or VS Code:</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/patch-1-271de3d1d77f0c68bf602f8ce8d1198b-dbeef.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 40%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABWklEQVQoz3WRWXKDMBBEOYdZBQhhVrPaoUjsxLGdtSr3v0xnZoizfOTj1ahHUjO0LN/3UdUlEqORJAliHUMTURwJOtHSkzXvkc7yDCY1SNcpQVXWhu5rWGx4u59xeTnh6fWMx/MDjgT37o8HvH+84fJ8ov5RevWmRj906PoWm2ZDw1Ro2kbWjBWGIdqONqoCw9hjmm+wP9xhmiaUVSkX+GDbtaKzLENZlkJRFKTXVJc+YwVBAMex4XoefKWgwgj8kVhruK6L1WoF27a/q+M4wn9rKyQT3/eQExUZG4IPMGzoEO4X10vMt7Z/tEdDWQEZumSWUahFUyMpC8RFjoiqot+JKXCZOObH0jDGSI2iaNGpWR6T9vk9LKUCBIEHQ4btMKAbR2y3W4xE13eY51n0brejnCvJjrNi4zzPJWPOMk1TKBpOMmTDMFTyBdbXeoUPLlk7f7L8ne01ok9Ra+lQ5yOH8AAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"patch file\"\n        title=\"\"\n        src=\"/static/patch-1-271de3d1d77f0c68bf602f8ce8d1198b-fb8a0.png\"\n        srcset=\"/static/patch-1-271de3d1d77f0c68bf602f8ce8d1198b-1a291.png 148w,\n/static/patch-1-271de3d1d77f0c68bf602f8ce8d1198b-2bc4a.png 295w,\n/static/patch-1-271de3d1d77f0c68bf602f8ce8d1198b-fb8a0.png 590w,\n/static/patch-1-271de3d1d77f0c68bf602f8ce8d1198b-526de.png 885w,\n/static/patch-1-271de3d1d77f0c68bf602f8ce8d1198b-fa2eb.png 1180w,\n/static/patch-1-271de3d1d77f0c68bf602f8ce8d1198b-dbeef.png 1310w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>As long as the file resides in your <code class=\"language-text\">patches</code> directory (with the correct name), it will automatically patch the module for both you and your colleagues when you install dependencies:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">&gt; yarn\nyarn install v0.27.5\n[1/4] Resolving packages...\n[2/4] Fetching packages...\n[3/4] Linking dependencies...\n[4/4] Building fresh packages...\n$ patch-package\npatch-package: Applying patches...\nreact-native-google-analytics-bridge@5.1.0 ✔</code></pre></div>\n<p>If the dependency you have patched is updated later, and the patch cannot be applied then you will get an error:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ patch-package\npatch-package: Applying patches...\n**ERROR** Failed to apply patch for package react-native-google-analytics-bridge</code></pre></div>\n<p>In that case you can either add/fix a new patch, if the thing you wanted fixed isn’t in the new version. Or delete the patch file if it is.</p>\n<h3>A simple solution</h3>\n<p>What I like about <code class=\"language-text\">patch-package</code> is that you do not depend on external repositories for minor fixes. You’re still installing the official dependency, with all the benefits that entails.</p>\n<p>And it is good that it doesn’t require any extra steps from your team members. Fix it once, and it happens automatically from there on.</p>\n<p>Of course, this utility will also work for non-RN projects. Pretty much any project that installs <code class=\"language-text\">npm</code> packages can use it.</p>\n<p>I hope more people will find this useful, as it has helped me a lot!</p>\n<p><strong>Note:</strong> This was orginally <a href=\"https://blog.novanet.no/easier-react-native-upgrade-with-patch-package/\">posted on the Novanet blog</a>. Check out that blog for more .NET- and RN-related content.</p>\n<hr>\n<div class=\"footnotes\">\n<hr>\n<ol>\n<li id=\"fn-1\">\n<p>  Open source does not work in isolation. If a module isn’t working, submit an issue, and then try to fix the problem yourself. If you fix the problem, submit a pull request. If you can’t figure out the problem, update the issue with details of your investigation into the problem. The people maintaining your dependencies are not paid to do so, so pay them back with a bit of your own time.</p>\n<a href=\"#fnref-1\" class=\"footnote-backref\">↩</a>\n</li>\n</ol>\n</div>","frontmatter":{"title":"Easier React Native upgrades with patch-package","date":"August 19, 2017"}}},"pageContext":{"slug":"/2017-08-19-patch-package/","previous":{"fields":{"slug":"/2017-07-31-setup-for-fast-ai-course/"},"frontmatter":{"title":"Setup for fast.ai course"}},"next":{"fields":{"slug":"/2018-03-08-your-first-vs-code-extension/"},"frontmatter":{"title":"Your first VS Code extension"}}}}